---
title: "Análisis Epidemiológico en R"
author: "Andree Valle-Campos"
date: '`r Sys.Date()`'
output:
  ioslides_presentation:
    widescreen: true
    smaller: true
    #incremental: true
    transition: faster
    df_print: paged
    #logo: "notrack/logo_emerge.png"
---

```{r setup, include=FALSE, message=FALSE,warning=FALSE,error=FALSE}
library(tidyverse)     #limpiar base de datos: http://r4ds.had.co.nz/
library(broom)         #limpiar output de modelos
library(haven)         #importar diferentes formatos
library(readxl)        #importar excel files
library(ggdag)         #crear DAGs y conjuntos de ajuste: https://ggdag.netlify.com/
library(compareGroups) #generar tabla 1 y 2
library(knitr)         #generar formato de tabla
library(kableExtra)    #generar formato extra de tabla
library(survival)      #analizar datos tiempo a evento
library(survminer)     #visualizar datos tiempo a evento
library(epiR)          #generar tablas epidemiológicas
library(epiDisplay)    #generar tablas epidemiológicas

set.seed(33)

knitr::opts_chunk$set(echo = TRUE,message=FALSE,warning=FALSE, error=FALSE)
theme_set(theme_bw())
```


```{r,eval=FALSE,echo=FALSE}
## LIMPIEZA Bases de datos
#- Caso Control
read_dta("data-raw/log23.dta") %>% 
  as_factor() %>% 
  mutate_if(is.numeric,as.factor) %>% 
  write_dta("data/cardio.dta")
read_dta("data-raw/log23.dta") %>% 
  as_factor() %>% 
  mutate_if(is.numeric,as.factor) %>% 
  as.data.frame() %>% 
  xlsx::write.xlsx("data/cardio.xlsx",row.names = F)
#- Cohorte
read_dta("data-raw/epidb.dta") %>% as_factor() %>% 
  mutate(aids=if_else(aids==0,"No","Yes"),
         race=if_else(race==1,"race1",if_else(race==2,"race2","race3")),
         ccr2=if_else(ccr2==1,"No","Yes"),
         ccr5=if_else(ccr5==1,"No","Yes"),
         sdf1=if_else(sdf1==1,"No","Yes")) %>% 
  mutate_if(is.character,as.factor) %>% 
  mutate_if(is.factor,fct_relevel, ... = "Yes") %>% 
  write_dta("data/aidsdb.dta")
#aidsdb %>% glimpse()
#aidsdb %>% count(race)
#levels(aidsdb$ccr2)
#- Transversal con baja prevalencia ¿PR u OR?
read_dta("data-raw/brfss2000.dta") %>% as_factor() %>% 
  filter(!is.na(depress)) %>% 
  write_sav("data/depres.sav")
#depres %>% 
#  count(cvd) %>% 
#  mutate(perd=n/sum(n)) #8% prevalencia
#- Transversal + no-convergencia
read_dta("data-raw/chronic2.dta") %>% as_factor() %>% 
  mutate(tcho2_n=as.numeric(tcho2),
         tcho2_nn=if_else(tcho2 == "No",0,1)) %>% 
  write_rds("data/cronic.rds")
#cronic %>% glimpse()
#cronic %>% count(tcho2) %>% 
#  mutate(perd=n/sum(n)) #30% prevalencia
```


## Temario

1. **Introducción** (30min)
    - Objetivos
    - Material de clase: RstudioCloud y archivos Rmarkdown.
    
2. **Estudios observacionales** (85min)
    - Caso-Control, Cohorte, Tiempo a evento

0. RECESO (20min)

3. **Modelos Lineales Generalizados** (55min)
    - Múltiples covariables
    - Distribuciones y funciones de enlace
    - Caso-Control, Cohorte

4. **Transversales** (50min)
    - Situación 1: prevalencia < 10%
    - Situación 2: no convergencia
    
0. CIERRE


## Objetivo

- Calcular e interpretar medidas de asociación empleadas en Estudios Epidemiológicos.

### Objetivos Específicos

- Conocer las caracaterísticas de R y Rstudio.

- Importar, describir y ejecutar análisis a partir de bases de datos.

- Tomar decisiones epidemiológicas y estadísticas en base a la pregunta y tipo de estudio.

## Material de clase

- **R**: Software Libre para el manejo, visualización y análisis de datos.
- **RStudio**: ambiente de desarrollo integrado (IDE).
- **Paquete**: Conjunto de funciones.
- **Función**: Código capaz de resolver un problema específico con datos.
- Archivo **.R**: Documento en _texto plano_ con funciones para resolver un problema de análisis amplio.
- Archivo **.Rmd**: Documento en _texto plano_ que integra texto, funciones y resultados. 


## Estudios Observacionales

- Asociar:
  + condición (**expuesto** o no-expuesto) y 
  + resultado (**caso** o control)

- El tipo de análisis depende del tipo de estudio:
  + _"Reclutamos $x_1$ sujetos **caso** y $x_2$ sujetos **control**"_
  + Tipo **Caso-Control**
  
  + _"Reclutamos $x_1$ sujetos **expuestos** y $x_2$ sujetos **no expuestos**"_
  + Tipo **Cohorte**

```{r,fig.cap="", out.width =  '500px',echo=FALSE}
knitr::include_graphics("notrack/epi-10.png")
```

```{r,echo=FALSE,eval=TRUE,fig.align='center',out.width="50%",results='asis',eval=FALSE}
t1 <- tribble(
  ~"tipo de estudio", ~"medida de asociación",
  "caso - control", "OR",
  "cohorte","RR",
  "transversal", "PR",
  "tiempo a evento", "HR"
) 

#knitr::kable(t1)

pander::pander(t1)

t1 %>% 
  kable("pandoc",format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),full_width = F,font_size = 10)
```


## 1.1 Caso-Control {.columns-2}

- El investigador elige el total de **casos y controles**

```{r,fig.cap="", out.width =  '500px',echo=FALSE}
knitr::include_graphics("notrack/epi-02.png")
```

- Si cambiamos el tamaño del grupo (**casos x 100**), **sí cambia** el Riesgo Relativo (RR)

```{r,echo=FALSE}
aidsdb %>% 
  count(ccr2,aids) %>% 
  spread(aids,n) %>% 
  mutate(Yes=Yes*100,
         risk=Yes/(No+Yes)) %>% 
  mutate(rr=c(.$risk[1]/.$risk[2],NA))
```

- En estudios caso-control usamos el **Odds Ratio (OR)** 

```{r,echo=FALSE}
aidsdb %>% 
  count(ccr2,aids) %>% 
  spread(aids,n) %>% 
  mutate(Yes=Yes*100,
         risk=Yes/(No+Yes),
         odds=Yes/No) %>% 
  mutate(rr=c(.$risk[1]/.$risk[2],NA),
         or=c(.$odds[1]/.$odds[2],NA))
```


## 1.2 Preguntas de investigación

**En personas VIH+ ¿el polimorfismo SDF1(CXCR12) está *asociado* con el desarrollo del SIDA?**

- base: `aidsdb.dta`
- exposición: `sdf1`
- desenlace: `aids`

```{r}
aidsdb <- read_dta("data/aidsdb.dta") %>% as_factor()
```


## 1.3 Estimar e interpretar OR

- Simularemos un escenario Caso-Control
- Seleccionaremos al azar **500 casos y 500 controles**

```{r}
aidsdb_or <- aidsdb %>% 
  group_by(aids) %>% 
  sample_n(150) %>% 
  ungroup()
```

## 1.4 **Tu turno 1**

**En personas VIH+ ¿el polimorfismo CCR5(delta-32) está *asociado* con el desarrollo del SIDA?**

## 2.1 Cohorte

- El investigador puede elegir el total de **expuestos y no expuestos**

```{r,fig.cap="", out.width =  '500px',echo=FALSE}
knitr::include_graphics("notrack/epi-01.png")
```

```{r,echo=FALSE}
aidsdb %>% 
  count(ccr2,aids) %>% 
  spread(aids,n) %>% 
  mutate(risk=Yes/(No+Yes)) %>% 
  mutate(rr=c(.$risk[1]/.$risk[2],NA))
```

- Si cambiamos el tamaño del grupo (**no-expuestos x 100**), **no cambia** el Riesgo Relativo (RR)

```{r,echo=FALSE}
aidsdb %>% 
  count(ccr2,aids) %>% 
  spread(aids,n) %>% 
  mutate(No=if_else(ccr2=="No",No*100,No %>% as.double()),
         Yes=if_else(ccr2=="No",Yes*100,Yes %>% as.double()),
         risk=Yes/(No+Yes)) %>% 
  mutate(rr=c(.$risk[1]/.$risk[2],NA))
```

## 2.2 Preguntas de investigación (2)

**En personas VIH+ ¿el polimorfismo SDF1(CXCR12) *protege* contra el desarrollo del SIDA?**

## 2.3 Estimar e interpretar OR

```{r}
aidsdb
```


## 2.4 **Tu turno 2**

**En personas VIH+ ¿el polimorfismo CCR5(delta-32) *protege* contra el desarrollo del SIDA?**

## 3.1 Tiempo a evento

```{r,fig.cap="", out.width =  '500px',echo=FALSE}
knitr::include_graphics("notrack/epi-03.png")
```

## 3.1 Tiempo a evento

```{r,fig.cap="", out.width =  '500px',echo=FALSE}
knitr::include_graphics("notrack/epi-04.png")
```

## 3.1 Tiempo a evento

```{r,fig.cap="", out.width =  '500px',echo=FALSE}
knitr::include_graphics("notrack/epi-05.png")
```

## 3.1 Tiempo a evento

```{r,fig.cap="", out.width =  '500px',echo=FALSE}
knitr::include_graphics("notrack/epi-06.png")
```

## 3.2 Preguntas de investigación (3)

**En personas VIH+ ¿el polimorfismo SDF1(CXCR12) contribuye con un mayor *tiempo* al inicio del SIDA?**

## 3.3 Gererar tabla Kaplan-Meier e interpretar Log-Rank test

```{r,echo=FALSE}
coxdb <- aidsdb %>% mutate(aids=as.integer(aids)-1)
```

```{r}
fit <- survfit(Surv(ttoaidsorexit, aids) ~ ccr5, data =  coxdb)
```

```{r}
#summary(fit)
fit %>% broom::tidy() #revisa el estrato!
#(1-(1/84)) * (1-(1/81))
```

```{r,fig.height=5,fig.width=7,echo=FALSE}
# Visualize with survminer
ggsurvplot(fit, data = coxdb, risk.table = TRUE,
           conf.int = T,ggtheme = theme_bw(),#ggtheme = theme_minimal(),
           pval = T,censor=FALSE,tables.theme = theme_cleantable())
```


## 3.4 **Tu turno 3**

**En personas VIH+ ¿el polimorfismo CCR5(delta-32) contribuye con un mayor *tiempo* al inicio del SIDA?**

## RECESO

## Múltiples covariables  {.columns-2}

### características

- **dos o más** variables independientes (múltiple)
- **una** variable dependiente

### objetivo

- **epidemiológico**: controlar **confusión** en el análisis.
  + estandarización (directa/indirecta), 
  + estratificación, 
  + puntajes de propensión, 
  + regresión _multivariable_

- **estadístico**: emplear múltiples predictores
  + lineales, no-lineales, segmentadas

```{r,fig.cap="", out.width =  '500px',echo=FALSE}
knitr::include_graphics("notrack/ggdag-epistat2019.png")
```

```{r, fig.align='center',fig.width=6,fig.height=4,echo=FALSE,out.width =  '500px',eval=FALSE}
dagconf <- dagify(y ~ x,
       y ~ conf + x,
       x ~ conf,
       labels = c("y" = "cáncer piel", 
                  "x" = "exp. solar",
                  "conf" = "café"
                  ),
       exposure = "x",
       outcome = "y")

ggdag_adjustment_set(dagconf, 
                     text = TRUE, use_labels = "label",label_size = 0.005,text_size = 4)
#ggdag_paths(dagconf, text = TRUE, use_labels = "label",label_size = 0.005,text_size = 4)
```

```{r,fig.cap="", out.width =  '250px',echo=FALSE,eval=FALSE}
knitr::include_graphics("notrack/multi-01.png")
```

```{r,fig.cap="", out.width =  '250px',echo=FALSE,eval=FALSE}
knitr::include_graphics("notrack/multi-02.png")
```

## Preguntas de investigación (5)

```{r}
depres <- read_sav("data/depres.sav") %>% as_factor()
cronic <- read_rds("data/cronic.rds")
cardio <- read_dta("data/cardio.dta") %>% as_factor()
cardio <- read_xlsx("data/cardio.xlsx") %>% 
  #mutate_all(as.numeric)
  mutate_at(.vars = c("edad","colesterol"),.funs = as.numeric) %>% 
  mutate_if(is.character,as.factor)
```

En adultos ¿la obesidad está *asociada* con la enfermedad cardiovascular? (cardio)

1. En adultos ¿la depresión está **asociada** con el evento cerebrovascular? (depres)

1. En adultos ¿la actividad física está **asociada** con la hipercolesterolemia? (cronic)

<!--cardio: caso-control x múltiple n=60 -->
<!--depress: prevalencia 8% ¿PR u OR? -->
<!--cronic: prevalencia 30% ¿Binomial o Poisson? -->

```{r,eval=FALSE}
#no convergencia
glm(tcho2 ~ age + sex + group + bmi_cat + diab + hba1c + ht + pa2 + smoke2 + alcohol2 + ndrug, 
    data = cronic, family = binomial(link = "log"))

#alternativa: poisson
glm(tcho2_n ~ age + sex + group + bmi_cat + diab + hba1c + ht + pa2 + smoke2 + alcohol2 + ndrug, 
    data = cronic, family = poisson(link = "log"))

glm(tcho2_nn ~ age + sex + group + bmi_cat + diab + hba1c + ht + pa2 + smoke2 + alcohol2 + ndrug, 
    data = cronic, family = poisson(link = "log"))

wm1 <- glm(tcho2_nn ~ 
             age + sex + group + bmi_cat + diab + hba1c + ht + pa2 + smoke2 + alcohol2 + ndrug, 
           data = cronic, family = poisson(link = "log"))
wm1 %>% tidy()
wm1 %>% confint_tidy()

cov.m1 <- sandwich::vcovHC(wm1, type="HC0")
std.err <- sqrt(diag(cov.m1))
r.est <- cbind(Estimate= coef(wm1), "Robust SE" = std.err,
"Pr(>|z|)" = 2 * pnorm(abs(coef(wm1)/std.err), lower.tail=FALSE),
LL = coef(wm1) - 1.96 * std.err,
UL = coef(wm1) + 1.96 * std.err)

r.est
```

## Modelos Lineales Generalizados

### careacterística

### objetivo

## GLM: familias distribución y funciones de enlace

- tabla

```{r,eval=FALSE,echo=FALSE}
#flujo de decisiones antes de optar por una distribución y una función en específico
#- tipo de estudio
#- prevalencia
#- no converge? cambiar de familia
# 
```


## GLM: verosimilitud


```{r, echo=FALSE, fig.cap="", out.width = '40%'}
knitr::include_graphics("notrack/nmeth.3904-F3_A.jpg")
```

## GLM: Regresión Logística {.columns-2}

- Se aplica cuando el desenlace es **categórico dicotómico**

- El término logístico refiere a la función de enlace **logit**, que convierte el resultado binario en una variable contínua de log(odds)

$$ log\left(\frac{\pi}{1-\pi}\right) =  \beta_0 + \beta_1 X_1 + . . . + \beta_n X_n + \epsilon $$

- El valor exponenciado de los coeficientes se pueden interpretar como **Odds Ratio (OR)**

```{r,fig.height=2,fig.width=3}
data_frame(p=seq(0,1,0.01)) %>% 
  mutate(odd=p/(1-p)) %>% 
  ggplot(aes(p,log(odd))) +
  geom_point() +
  coord_flip()
```

```{r,fig.height=2,fig.width=3,eval=FALSE,echo=FALSE}
data_frame(p=seq(0,1,0.01)) %>% 
  mutate(odd=p/(1-p)) %>% 
  ggplot(aes(p,log(p))) +
  geom_point() +
  coord_flip()
```

## OR: Caso-Control {.columns-2}

- Simularemos un escenario Caso-Control
- Seleccionaremos al azar **500 casos y 500 controles**

```{r}
aidsdb_or <- aidsdb %>% 
  group_by(aids) %>% 
  sample_n(50) %>% 
  ungroup()
```

```{r,fig.height=2,fig.width=3, echo=TRUE}
aidsdb_or %>% ggplot(aes(aids,fill=ccr2)) +
  geom_bar(position = "fill")
```

```{r}
aidsdb_or %>% 
  count(aids) %>% 
  mutate(prc=n/sum(n))
```

```{r, echo=FALSE}
aidsdb_or %>% 
  count(ccr2,aids) %>% 
  spread(aids,n) %>% 
  mutate(odds=Yes/No) %>% 
  mutate(or=c(NA_real_,.$odds[2]/.$odds[1]))
```

```{r}
compareGroups(aids ~ ccr2 + ccr5 + sdf1 + race,data = aidsdb,byrow=T) %>% 
  createTable(show.ratio = T)
```

```{r}
aidsdb %>% 
  count(ccr2,aids) %>% 
  spread(aids,n) %>% 
  mutate(Yes=Yes,
         prev=Yes/(No+Yes),
         odds=Yes/No) %>% 
  mutate(pr=c(.$prev[1]/.$prev[2],NA),
         or=c(.$odds[1]/.$odds[2],NA))

compareGroups(aids ~ ccr2,data = aidsdb,byrow=T) %>% 
  createTable(show.ratio = T)

with(aidsdb,table(ccr2,aids))

epi.2by2(with(aidsdb,table(ccr2,aids)),
         method = "cross.sectional")
```

```{r}
data(Oswego)
Oswego %>% as_tibble() %>% count(ill,chocolate)
cc(Oswego$ill,Oswego$chocolate) #case-control
cs(Oswego$ill,Oswego$chocolate) #cross-sectional
```


```{r,eval=FALSE}
levels(aidsdb_or$aids)

epi_or <- function(data,outcome,exposure) {
  
  outcome_ <- enquo(outcome)
  exposure_ <- enquo(exposure)
  
  data_or <- data %>% 
  count(!!exposure_,!!outcome_) %>% 
  spread(!!outcome_,n) #%>% 
  #mutate(odds=levels(.$!!outcome)[2]/levels(.$!!outcome)[1]) #%>% 
  #mutate(or=c(NA_real_,.$odds[2]/.$odds[1]))
  return(data_or)
}

epi_or(aidsdb_or,aids,ccr2)
```


## OR: coeficientes de variables categóricas

```{r}
wm1 <- glm(aids ~ ccr2, data = aidsdb_or, family = binomial(link = "logit"))
```

```{r,echo=FALSE}
#wm1 %>% glance()
m1 <- wm1 %>% tidy() %>% mutate(or=exp(estimate)) %>% rownames_to_column()
m2 <- wm1 %>% confint_tidy() %>% mutate_all(funs(exp)) %>% rownames_to_column()
left_join(m1,m2) %>% dplyr::select(term,log.or=estimate,or,conf.low,conf.high,p.value)
```

- $\beta_0$
- En la población, el **odds** de tener sida dado que **no poseen CCR2** es **`r round(m1$or[1],2)`**,
- con un intervalo de confianza al 95% de `r round(m2$conf.low[1],2)` a `r round(m2$conf.high[1],2)`

- $\beta_{CCR2:Yes}$
- En la población, el **odds** de tener sida dado que **sí poseen CCR2** es
- **`r round(m1$or[2],2)`** veces, 
- el **odds** de tener depresión dado que **no poseen CCR2**,
- con un intervalo de confianza al 95% de `r round(m2$conf.low[2],2)` a `r round(m2$conf.high[2],2)`.
- Este resultado no es estadísticamente significativo con un valor **p = `r round(m1$p.value[2],3)`**

## OR: coeficientes de variables contínuas 

```{r}
wm1 <- glm(aids ~ age, data = aidsdb_or, family = binomial(link = "logit"))
```

```{r,echo=FALSE}
#wm1 %>% glance()
m1 <- wm1 %>% tidy() %>% mutate(or=exp(estimate)) %>% rownames_to_column()
m2 <- wm1 %>% confint_tidy() %>% mutate_all(funs(exp)) %>% rownames_to_column()
left_join(m1,m2) %>% dplyr::select(term,log.or=estimate,or,conf.low,conf.high,p.value)
```

- $\beta_{edad}$
- En la población, por cada incremento en un año de **edad**,
- el **odds** de sida _cambia_ en **`r round(m1$or[2],2)`**, con un intervalo de confianza AL 95% de `r round(m2$conf.low[2],2)` a `r round(m2$conf.high[2],2)`.
- Este resultado no es estadísticamente significativo con un valor **p = `r round(m1$p.value[2],3)`**
 
```{r,fig.height=3,fig.width=3, echo=FALSE, eval=FALSE}
## OR: supuesto
wm1 %>% 
  augment() %>% 
  ggplot() +
  geom_qq(aes(sample=.std.resid)) + 
  geom_qq_line(aes(sample=.std.resid))

#**META:** todos los puntos sobre la línea
```

```{r,fig.height=3,fig.width=3,eval=FALSE, echo=FALSE}
wm1 %>% augment() %>% 
  ggplot(aes(.std.resid)) +
  geom_histogram()
  #geom_density()
```

```{r,fig.height=3,fig.width=3,message=FALSE,error=FALSE, echo=FALSE,eval=FALSE}
wm1 %>% 
  augment() %>% 
  ggplot(aes(age,.std.resid)) +
  geom_point() +
  geom_smooth() +
  geom_hline(yintercept = c(0))
#- **META:** distribución idéntica a ambos lados de la línea
```

## RR: Cohorte

```{r}
wm1 <- glm(aids ~ ccr2, data = aidsdb, family = binomial(link = "log"))
```

```{r,echo=FALSE}
#wm1 %>% glance()
m1 <- wm1 %>% tidy() %>% mutate(or=exp(estimate)) %>% rownames_to_column()
m2 <- wm1 %>% confint_tidy() %>% mutate_all(funs(exp)) %>% rownames_to_column()
left_join(m1,m2) %>% dplyr::select(term,log.or=estimate,or,conf.low,conf.high,p.value)
```

- $\beta_0$
- En la población, el **riesgo** de sida dado que **no poseen CCR2** es **`r round(m1$or[1],2)`**,
- con un intervalo de confianza AL 95% de `r round(m2$conf.low[1],2)` a `r round(m2$conf.high[1],2)`

- $\beta_{ccr2:yes}$
- En la población, el **riesgo** de tener sida dado que **sí poseen CCR2** es
- **`r round(m1$or[2],2)`** veces, 
- el **riesgo** de tener sida dado que **no poseen CCR2**,
- con un intervalo de confianza AL 95% de `r round(m2$conf.low[2],2)` a `r round(m2$conf.high[2],2)`.
- Este resultado no es estadísticamente significativo con un valor **p = `r round(m1$p.value[2],3)`**


## PR: Transversal

```{r}
wm1 <- glm(depress ~ short, data = depres, family = binomial(link = "log"))
```

```{r,echo=FALSE}
#wm1 %>% glance()
m1 <- wm1 %>% tidy() %>% mutate(or=exp(estimate)) %>% rownames_to_column()
m2 <- wm1 %>% confint_tidy() %>% mutate_all(funs(exp)) %>% rownames_to_column()
left_join(m1,m2) %>% dplyr::select(term,log.or=estimate,or,conf.low,conf.high,p.value)
```

- $\beta_0$
- En la población, la **prevalencia** de depresión en sujetos que **estatura alta** es **`r round(m1$or[1],2)`**,
- con un intervalo de confianza AL 95% de `r round(m2$conf.low[1],2)` a `r round(m2$conf.high[1],2)`

- $\beta_{estatura:baja}$
- En la población, la **prevalencia** de tener depresión dado que se es de **estatura baja** es
- **`r round(m1$or[2],2)`** veces, 
- el **prevalencia** de tener depresión dado que se es de **estatura alta**,
- con un intervalo de confianza AL 95% de `r round(m2$conf.low[2],2)` a `r round(m2$conf.high[2],2)`.
- Este resultado es estadísticamente significativo con un valor **p = `r round(m1$p.value[2],3)`**



## Tiempo a evento: Regresión de Cox (HR)

- evaluar supuestos!

```{r,eval=FALSE}
res.cox <- coxph(Surv(ttoaidsorexit, aids) ~ ccr5, data =  coxdb)

#res.cox %>% glance()
m1 <- res.cox %>% tidy() %>% rownames_to_column()
m2 <- res.cox %>% confint_tidy() %>% rownames_to_column()
left_join(m1,m2) %>% dplyr::select(-rowname)
#res.cox %>% augment()
```


## Referencias

### Presentaciones

- Curso de Bioestadística. Maestría en Ciencias de la Investigación Epidemiológica. UPCH 2018.
- José Alfredo Zavala. Regresión Lineal. 2018
- Harold Akehurst. Bioestadística con R. Julio 2016

### enlaces web

- Statistics for Biologist: Points of Significance. Link: `https://www.nature.com/collections/qghhqm/pointsofsignificance`
- Association of gene polymorphism of SDF1(CXCR12) with susceptibility to HIV-1 infection and AIDS disease progression: A meta-analysis. PLoS One. 2018 Feb 8. `https://www.ncbi.nlm.nih.gov/pubmed/29420545`
- Protective effect of CCR5 Delta-32 allele against HIV-1 in Mexican women. Curr HIV Res. 2013 Sep `https://www.ncbi.nlm.nih.gov/pubmed/24382026`

## CIERRE: ¿Qué no hemos podido ver?

- Manipulación, limpieza y visualización de datos: `http://r4ds.had.co.nz/`
- Análisis y visualización de DAGs: `https://ggdag.netlify.com/`

```{r,fig.cap="", out.width =  '500px',echo=FALSE}
knitr::include_graphics("notrack/tidy-00.png")
```

```{r,eval=FALSE,echo=FALSE,message=FALSE}
#generar material para estudiantes
purl("r01.Rmd", output = "r01.R", documentation = 2)
purl("r02.Rmd", output = "r02.R", documentation = 2)
```


```{r cars, eval=FALSE, echo=FALSE}
esoph %>% as_tibble()
```

```{r, eval=FALSE , echo=FALSE}
require(stats)
require(graphics) # for mosaicplot

esoph <- as_tibble(esoph)

summary(esoph)
```

```{r, eval=FALSE , echo=FALSE}
prop.table(table(esoph$agegp))
```

```{r, eval=FALSE , echo=FALSE}
## effects of alcohol, tobacco and interaction, age-adjusted
model1 <- glm(cbind(ncases, ncontrols) ~ agegp + tobgp * alcgp,
              data = esoph, family = binomial())
anova(model1)

summary(model1)

attributes(model1)

#broom::augment(model1)
broom::tidy(model1)
broom::confint_tidy(model1)
broom::glance(model1)

plot(model1,which = 1) #homoscedasticidad (de predichos yhat vs residuales)
plot(model1,which = 2) #normalidad (de residuales)
```

```{r, eval=FALSE , echo=FALSE}
## Try a linear effect of alcohol and tobacco
model2 <- glm(cbind(ncases, ncontrols) ~ agegp + unclass(tobgp)
                                         + unclass(alcgp),
              data = esoph, family = binomial())
summary(model2)
```

```{r, eval=FALSE , echo=FALSE}
## Re-arrange data for a mosaic plot
ttt <- table(esoph$agegp, esoph$alcgp, esoph$tobgp)
o <- with(esoph, order(tobgp, alcgp, agegp))
ttt[ttt == 1] <- esoph$ncases[o]
tt1 <- table(esoph$agegp, esoph$alcgp, esoph$tobgp)
tt1[tt1 == 1] <- esoph$ncontrols[o]
tt <- array(c(ttt, tt1), c(dim(ttt),2),
            c(dimnames(ttt), list(c("Cancer", "control"))))
mosaicplot(tt, main = "esoph data set", color = TRUE)
```


```{r,eval=FALSE}
## IRR: Desenlaces conteo o tasas
glm(response~predictor1+predictor2+predictor3+ ... + offset(log(population)),
     family=poisson,data=...)
#https://stats.stackexchange.com/questions/66791/where-does-the-offset-go-in-poisson-negative-binomial-regression/66878#66878
#https://stackoverflow.com/questions/16046726/regression-for-a-rate-variable-in-r
```

```{r,eval=FALSE,echo=FALSE}
#objetivo:
#demostrar que a menor proporción del desenlace, 
#el OR se aproxima al PR
#lo que me lleva a decidir el tipo de link en GLM,
#de acuerdo a la prevalencia del outcome
data_frame(prop.y=seq(0.01,1,0.01),
           n=100,
           prop.x=0.25) %>% 
  mutate(rr=(n/prop.x) / (n/prop.x)
         )
```
