---
title: "Modelos Lineales II"
author: "Andree Valle-Campos"
date: '`r Sys.Date()`'
output:
  ioslides_presentation:
    widescreen: true
    smaller: true
    #incremental: true
    transition: faster
    #logo: "notrack/logo_emerge.png"
---

```{r setup, include=FALSE, message=FALSE}
library(tidyverse)
library(broom)
library(haven)
library(ggdag)
library(compareGroups)
library(knitr)
library(kableExtra)
library(survival)
library(survminer)
library(epiR)

set.seed(33)

knitr::opts_chunk$set(echo = TRUE,message=FALSE,warning=FALSE, error=FALSE)
theme_set(theme_bw())
```

## Temario

1. **Introducción** (5min)
2. **Regresión Lineal** 
    - Simple (30min)
    - ejercicios (15min)
    - Múltiple (20min)
    - ejercicios (15min)
5. **Estudios observacionales** (25min)
    - TEMA: Encuesta 
    - Transversales
    - Caso-Control

0. RECESO (20min)

4. **Modelos Lineales Generalizados** (40min)
    - tabla con uso de fun y link (10min)
    - Odds Ratio
    - Prevalence Ratio: Binomial o Poisson?
    - Ejercicios (30min)
6. **Estudios prospectivos** (40min)
    - TEMA: AIDS
    - Cohortes - Risk Ratio  
    - Tiempo a evento - LogRank test
    - Ejercicios (15min)
    - Desenlace conteo o tasa - Incidence Risk Ratio (¿?)

## Introducción

### ¿**qué** es R?

- Software Libre

### ¿**por qué** usar R?

- Ciencia Reproducible:
  - limpiar bases de datos
  - visualizar
  - ejecutar modelos 
  - comunicar resultados

### ¿**cómo** usar R?

- IDE: RStudio
- Paquetes
- Funciones


## Estudios Observacionales

- Asociar:
  + condición (**expuesto** o no-expuesto) y 
  + resultado (**caso** o control)

- El tipo de análisis depende del tipo de estudio:
  + _"Reclutamos $x_1$ sujetos **expuestos** y $x_2$ sujetos **no expuestos**"_
  + Tipo **Cohorte**
  
  + _"Reclutamos $x_1$ sujetos **caso** y $x_2$ sujetos **control**"_
  + Tipo **Caso-Control**

```{r,echo=FALSE,eval=TRUE,fig.align='center',out.width="50%"}
t1 <- tribble(
  ~"tipo de estudio", ~"medida de asociación",
  "caso - control", "OR",
  "cohorte","RR",
  "transversal", "PR",
  "tiempo a evento", "HR"
) 
t1 %>% 
  kable("pandoc") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),full_width = F,font_size = 10)
```

## Bases de datos

- Cohorte

```{r}
riskdb <- read_dta("data-raw/epidb.dta") %>% as_factor() %>% 
  mutate(aids=if_else(aids==0,"No","Yes"),
         race=if_else(race==1,"race1",if_else(race==2,"race2","race3")),
         ccr2=if_else(ccr2==1,"No","Yes"),
         ccr5=if_else(ccr5==1,"No","Yes"),
         sdf1=if_else(sdf1==1,"No","Yes")) %>% 
  mutate_if(is.character,as.factor) %>% 
  mutate_if(is.factor,fct_relevel, ... = "Yes")

riskdb %>% count(race)

levels(riskdb$ccr2)
```

- Encuesta a nivel nacional

```{r}
logdb <- read_dta("data-raw/brfss2000.dta") %>% as_factor() %>% 
  filter(!is.na(depress))
  #mutate(dn_cro=as.factor(dn_cro))
```

## Cohorte

- Elegimos los totales de **expuestos y no expuestos**

```{r}
riskdb %>% 
  count(ccr2,aids) %>% 
  spread(aids,n) %>% 
  mutate(risk=Yes/(No+Yes)) %>% 
  mutate(rr=.$risk[2]/.$risk[1])
```

- Si cambiamos el tamaño del grupo (**no-expuestos x 100**), **no cambia** el Riesgo Relativo (RR)

```{r,echo=FALSE}
riskdb %>% 
  count(ccr2,aids) %>% 
  spread(aids,n) %>% 
  mutate(No=if_else(ccr2=="No",No*100,No %>% as.double()),
         Yes=if_else(ccr2=="No",Yes*100,Yes %>% as.double()),
         risk=Yes/(No+Yes)) %>% 
  mutate(rr=.$risk[2]/.$risk[1])
```

## Caso Control


- Elegimos los totales de **casos y controles**

- Si cambiamos el tamaño del grupo (**casos x 100**), **sí cambia** el Riesgo Relativo (RR)

```{r,eval=FALSE}
riskdb %>% 
  count(ccr2,aids) %>% 
  spread(aids,n) %>% 
  mutate(Yes=Yes*100,
         risk=Yes/(No+Yes)) %>% 
  mutate(rr=.$risk[2]/.$risk[1])
```

- En estudios caso-control usamos el **Odds Ratio (OR)** 

```{r,echo=FALSE}
riskdb %>% 
  count(ccr2,aids) %>% 
  spread(aids,n) %>% 
  mutate(Yes=Yes*100,
         risk=Yes/(No+Yes),
         odds=Yes/No) %>% 
  mutate(rr=.$risk[2]/.$risk[1],
         or=.$odds[2]/.$odds[1])
```

- **sobreestima** el Riesgo Relativo (RR)

```{r,eval=FALSE,echo=FALSE}
#objetivo:
#demostrar que a menor proporción del desenlace, 
#el OR se aproxima al PR
#lo que me lleva a decidir el tipo de link en GLM,
#de acuerdo a la prevalencia del outcome
data_frame(prop.y=seq(0.01,1,0.01),
           n=100,
           prop.x=0.25) %>% 
  mutate(rr=(n/prop.x) / (n/prop.x)
         )
```


## Modelos Lineales Generalizados

### careacterística

### objetivo

## GLM: familias distribución y funciones de enlace

- tabla

```{r,eval=FALSE,echo=FALSE}
#flujo de decisiones antes de optar por una distribución y una función en específico
#- tipo de estudio
#- prevalencia
#- no converge? cambiar de familia
# 
```


## GLM: verosimilitud


```{r, echo=FALSE, fig.cap="", out.width = '40%'}
knitr::include_graphics("notrack/nmeth.3904-F3_A.jpg")
```

## GLM: Regresión Logística {.columns-2}

- Se aplica cuando el desenlace es **categórico dicotómico**

- El término logístico refiere a la función de enlace **logit**, que convierte el resultado binario en una variable contínua de log(odds)

$$ log\left(\frac{\pi}{1-\pi}\right) =  \beta_0 + \beta_1 X_1 + . . . + \beta_n X_n + \epsilon $$

- El valor exponenciado de los coeficientes se pueden interpretar como **Odds Ratio (OR)**

```{r,fig.height=2,fig.width=3}
data_frame(p=seq(0,1,0.01)) %>% 
  mutate(odd=p/(1-p)) %>% 
  ggplot(aes(p,log(odd))) +
  geom_point() +
  coord_flip()
```

```{r,fig.height=2,fig.width=3,eval=FALSE,echo=FALSE}
data_frame(p=seq(0,1,0.01)) %>% 
  mutate(odd=p/(1-p)) %>% 
  ggplot(aes(p,log(p))) +
  geom_point() +
  coord_flip()
```

## GLM: ¿bondad de ajuste?

- LogLikelihood
- Information Criterias
  + AIC
  + BIC

## GLM: ¿Supuestos?

## OR: Caso-Control {.columns-2}

- Simularemos un escenario Caso-Control
- Seleccionaremos al azar **500 casos y 500 controles**

```{r}
riskdb_or <- riskdb %>% 
  group_by(aids) %>% 
  sample_n(50) %>% 
  ungroup()
```

```{r,fig.height=2,fig.width=3, echo=TRUE}
riskdb_or %>% ggplot(aes(aids,fill=ccr2)) +
  geom_bar(position = "fill")
```

```{r}
riskdb_or %>% 
  count(aids) %>% 
  mutate(prc=n/sum(n))
```

```{r, echo=FALSE}
riskdb_or %>% 
  count(ccr2,aids) %>% 
  spread(aids,n) %>% 
  mutate(odds=Yes/No) %>% 
  mutate(or=c(NA_real_,.$odds[2]/.$odds[1]))
```

```{r}
compareGroups(aids ~ ccr2 + ccr5 + sdf1 + race,data = riskdb,byrow=T) %>% 
  createTable(show.ratio = T)
```

```{r}
riskdb %>% 
  count(ccr2,aids) %>% 
  spread(aids,n) %>% 
  mutate(Yes=Yes,
         prev=Yes/(No+Yes),
         odds=Yes/No) %>% 
  mutate(pr=c(.$prev[1]/.$prev[2],NA),
         or=c(.$odds[1]/.$odds[2],NA))

compareGroups(aids ~ ccr2,data = riskdb,byrow=T) %>% 
  createTable(show.ratio = T)

with(riskdb,table(ccr2,aids))

epi.2by2(with(riskdb,table(ccr2,aids)),
         method = "cross.sectional")
```


```{r,eval=FALSE}
levels(riskdb_or$aids)

epi_or <- function(data,outcome,exposure) {
  
  outcome_ <- enquo(outcome)
  exposure_ <- enquo(exposure)
  
  data_or <- data %>% 
  count(!!exposure_,!!outcome_) %>% 
  spread(!!outcome_,n) #%>% 
  #mutate(odds=levels(.$!!outcome)[2]/levels(.$!!outcome)[1]) #%>% 
  #mutate(or=c(NA_real_,.$odds[2]/.$odds[1]))
  return(data_or)
}

epi_or(riskdb_or,aids,ccr2)
```


## OR: coeficientes de variables categóricas

```{r}
wm1 <- glm(aids ~ ccr2, data = riskdb_or, family = binomial(link = "logit"))
```

```{r,echo=FALSE}
#wm1 %>% glance()
m1 <- wm1 %>% tidy() %>% mutate(odds=exp(estimate)) %>% rownames_to_column()
m2 <- wm1 %>% confint_tidy() %>% mutate_all(funs(exp)) %>% rownames_to_column()
left_join(m1,m2) %>% select(term,log.odds=estimate,odds,conf.low,conf.high,p.value)
```

- $\beta_0$
- En la población, el **odds** de tener sida dado que **no poseen CCR2** es **`r round(m1$odds[1],2)`**,
- con un intervalo de confianza al 95% de `r round(m2$conf.low[1],2)` a `r round(m2$conf.high[1],2)`

- $\beta_{CCR2:Yes}$
- En la población, el **odds** de tener sida dado que **sí poseen CCR2** es
- **`r round(m1$odds[2],2)`** veces, 
- el **odds** de tener depresión dado que **no poseen CCR2**,
- con un intervalo de confianza al 95% de `r round(m2$conf.low[2],2)` a `r round(m2$conf.high[2],2)`.
- Este resultado no es estadísticamente significativo con un valor **p = `r round(m1$p.value[2],3)`**

## OR: coeficientes de variables contínuas 

```{r}
wm1 <- glm(aids ~ age, data = riskdb_or, family = binomial(link = "logit"))
```

```{r,echo=FALSE}
#wm1 %>% glance()
m1 <- wm1 %>% tidy() %>% mutate(odds=exp(estimate)) %>% rownames_to_column()
m2 <- wm1 %>% confint_tidy() %>% mutate_all(funs(exp)) %>% rownames_to_column()
left_join(m1,m2) %>% select(term,log.odds=estimate,odds,conf.low,conf.high,p.value)
```

- $\beta_{edad}$
- En la población, por cada incremento en un año de **edad**,
- el **odds** de sida _cambia_ en **`r round(m1$odds[2],2)`**, con un intervalo de confianza AL 95% de `r round(m2$conf.low[2],2)` a `r round(m2$conf.high[2],2)`.
- Este resultado no es estadísticamente significativo con un valor **p = `r round(m1$p.value[2],3)`**
 
```{r,fig.height=3,fig.width=3, echo=FALSE, eval=FALSE}
## OR: supuesto
wm1 %>% 
  augment() %>% 
  ggplot() +
  geom_qq(aes(sample=.std.resid)) + 
  geom_qq_line(aes(sample=.std.resid))

#**META:** todos los puntos sobre la línea
```

```{r,fig.height=3,fig.width=3,eval=FALSE, echo=FALSE}
wm1 %>% augment() %>% 
  ggplot(aes(.std.resid)) +
  geom_histogram()
  #geom_density()
```

```{r,fig.height=3,fig.width=3,message=FALSE,error=FALSE, echo=FALSE,eval=FALSE}
wm1 %>% 
  augment() %>% 
  ggplot(aes(age,.std.resid)) +
  geom_point() +
  geom_smooth() +
  geom_hline(yintercept = c(0))
#- **META:** distribución idéntica a ambos lados de la línea
```

## RR: Cohorte

```{r}
wm1 <- glm(aids ~ ccr2, data = riskdb, family = binomial(link = "log"))
```

```{r,echo=FALSE}
#wm1 %>% glance()
m1 <- wm1 %>% tidy() %>% mutate(odds=exp(estimate)) %>% rownames_to_column()
m2 <- wm1 %>% confint_tidy() %>% mutate_all(funs(exp)) %>% rownames_to_column()
left_join(m1,m2) %>% select(term,log.odds=estimate,odds,conf.low,conf.high,p.value)
```

- $\beta_0$
- En la población, el **riesgo** de sida dado que **no poseen CCR2** es **`r round(m1$odds[1],2)`**,
- con un intervalo de confianza AL 95% de `r round(m2$conf.low[1],2)` a `r round(m2$conf.high[1],2)`

- $\beta_{ccr2:yes}$
- En la población, el **riesgo** de tener sida dado que **sí poseen CCR2** es
- **`r round(m1$odds[2],2)`** veces, 
- el **riesgo** de tener sida dado que **no poseen CCR2**,
- con un intervalo de confianza AL 95% de `r round(m2$conf.low[2],2)` a `r round(m2$conf.high[2],2)`.
- Este resultado no es estadísticamente significativo con un valor **p = `r round(m1$p.value[2],3)`**


## PR: Transversal

```{r}
wm1 <- glm(depress ~ short, data = logdb, family = binomial(link = "log"))
```

```{r,echo=FALSE}
#wm1 %>% glance()
m1 <- wm1 %>% tidy() %>% mutate(odds=exp(estimate)) %>% rownames_to_column()
m2 <- wm1 %>% confint_tidy() %>% mutate_all(funs(exp)) %>% rownames_to_column()
left_join(m1,m2) %>% select(term,log.odds=estimate,odds,conf.low,conf.high,p.value)
```

- $\beta_0$
- En la población, la **prevalencia** de depresión en sujetos que **estatura alta** es **`r round(m1$odds[1],2)`**,
- con un intervalo de confianza AL 95% de `r round(m2$conf.low[1],2)` a `r round(m2$conf.high[1],2)`

- $\beta_{estatura:baja}$
- En la población, la **prevalencia** de tener depresión dado que se es de **estatura baja** es
- **`r round(m1$odds[2],2)`** veces, 
- el **prevalencia** de tener depresión dado que se es de **estatura alta**,
- con un intervalo de confianza AL 95% de `r round(m2$conf.low[2],2)` a `r round(m2$conf.high[2],2)`.
- Este resultado es estadísticamente significativo con un valor **p = `r round(m1$p.value[2],3)`**


## HR: Tiempo a evento

### Log-Rank test

```{r,echo=FALSE}
coxdb <- riskdb %>% 
  mutate(aids=as.integer(aids)-1)
```

```{r,fig.height=5,fig.width=7,echo=FALSE}
fit <- survfit(Surv(ttoaidsorexit, aids) ~ ccr2, data =  coxdb)
# Visualize with survminer
ggsurvplot(fit, data = coxdb, risk.table = TRUE,
           conf.int = T,ggtheme = theme_bw(),#ggtheme = theme_minimal(),
           pval = T,censor=FALSE,tables.theme = theme_cleantable())
```

## HR: Tiempo a evento

### Regresión de Cox

```{r}
res.cox <- coxph(Surv(ttoaidsorexit, aids) ~ ccr2, data =  coxdb)
```

```{r,echo=FALSE}
#res.cox %>% glance()
m1 <- res.cox %>% tidy() %>% rownames_to_column()
m2 <- res.cox %>% confint_tidy() %>% rownames_to_column()
left_join(m1,m2) %>% select(-rowname)
#res.cox %>% augment()
```

## IRR: Desenlaces conteo o tasas

```{r,eval=FALSE}
glm(response~predictor1+predictor2+predictor3+ ... + offset(log(population)),
     family=poisson,data=...)
#https://stats.stackexchange.com/questions/66791/where-does-the-offset-go-in-poisson-negative-binomial-regression/66878#66878
#https://stackoverflow.com/questions/16046726/regression-for-a-rate-variable-in-r
```


## Referencias

### Presentaciones

- Curso de Bioestadística. Maestría en Ciencias de la Investigación Epidemiológica. UPCH 2018.
- José Alfredo Zavala. Regresión Lineal. 2018
- Harold Akehurst. Bioestadística con R. Julio 2016

### enlaces web

- StatQuest: Linear Models Pt.1 - Linear Regression. Link: `https://youtu.be/nk2CQITm_eo`
- Statistics for Biologist: Points of Significance. Link: `https://www.nature.com/collections/qghhqm/pointsofsignificance`


```{r cars, eval=FALSE, echo=FALSE}
esoph %>% as_tibble()
```

```{r, eval=FALSE , echo=FALSE}
require(stats)
require(graphics) # for mosaicplot

esoph <- as_tibble(esoph)

summary(esoph)
```

```{r, eval=FALSE , echo=FALSE}
prop.table(table(esoph$agegp))
```

```{r, eval=FALSE , echo=FALSE}
## effects of alcohol, tobacco and interaction, age-adjusted
model1 <- glm(cbind(ncases, ncontrols) ~ agegp + tobgp * alcgp,
              data = esoph, family = binomial())
anova(model1)

summary(model1)

attributes(model1)

#broom::augment(model1)
broom::tidy(model1)
broom::confint_tidy(model1)
broom::glance(model1)

plot(model1,which = 1) #homoscedasticidad (de predichos yhat vs residuales)
plot(model1,which = 2) #normalidad (de residuales)
```

```{r, eval=FALSE , echo=FALSE}
## Try a linear effect of alcohol and tobacco
model2 <- glm(cbind(ncases, ncontrols) ~ agegp + unclass(tobgp)
                                         + unclass(alcgp),
              data = esoph, family = binomial())
summary(model2)
```

```{r, eval=FALSE , echo=FALSE}
## Re-arrange data for a mosaic plot
ttt <- table(esoph$agegp, esoph$alcgp, esoph$tobgp)
o <- with(esoph, order(tobgp, alcgp, agegp))
ttt[ttt == 1] <- esoph$ncases[o]
tt1 <- table(esoph$agegp, esoph$alcgp, esoph$tobgp)
tt1[tt1 == 1] <- esoph$ncontrols[o]
tt <- array(c(ttt, tt1), c(dim(ttt),2),
            c(dimnames(ttt), list(c("Cancer", "control"))))
mosaicplot(tt, main = "esoph data set", color = TRUE)
```

