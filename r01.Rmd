---
title: "Modelos Lineales"
author: "Andree Valle-Campos"
date: '`r Sys.Date()`'
output:
  ioslides_presentation:
    widescreen: true
    smaller: true
    #incremental: true
    transition: faster
    #logo: "notrack/logo_emerge.png"
---

```{r setup, include=FALSE, message=FALSE}
library(tidyverse)
library(broom)
library(haven)
library(ggdag)
library(compareGroups)
library(knitr)
library(kableExtra)
library(survival)
library(survminer)

set.seed(33)

knitr::opts_chunk$set(echo = TRUE,message=FALSE,warning=FALSE, error=FALSE)
theme_set(theme_bw())
```

## Temario

1. **Introducción**
2. **Regresión Lineal** 
    - Simple
    - Múltiple
5. **Estudios observacionales**
    - Transversales
    - Caso-Control
4. **Modelos Lineales Generalizados**
    - Odds Ratio
    - Prevalence Ratio
6. **Estudios adicionales**
    - Cohortes - Risk Ratio
    - Tiempo a evento - Hazard Ratio
    - Desenlace conteo o tasa - Incidence Risk Ratio

## Introducción

### ¿**qué** es R?

- Software Libre

### ¿**por qué** usar R?

- Ciencia Reproducible:
  - limpiar bases de datos
  - visualizar
  - ejecutar modelos 
  - comunicar resultados

### ¿**cómo** usar R?

- IDE: RStudio
- Paquetes
- Funciones

## Introducción

### ¿**por qué** usar una **regresión**?

- permite fijar al menos una **variable independiente** o **exposición** y observar una respuesta en la **variable dependiente** o **desenlace**.

- permite **explicar** el cambio promedio de un evento $Y$ en base a cambios en $X$, usando coeficientes o medidas de asociación.

- permite **predecir** la probabilidad asociada a un evento.

- .

<!-- direccionalidad -> causalidad || clasificar -->

```{r, echo=FALSE, fig.cap="", out.width = '90%',fig.align='center'}
knitr::include_graphics("notrack/nmeth.3627-F1.jpg")
```

## Regresión Lineal Simple  {.columns-2}

### características

- **una** variable independiente (simple)
- **una** variable dependiente (univariada)
- ambas variables deben ser **numéricas**

### objetivos

- ajustar datos a una recta
- interpretar medida de bondad de ajuste ( _R^2^_ ) y coeficientes
- evaluar supuestos
- visualizar el modelo

```{r, echo=FALSE,fig.height=4,fig.width=3}
women %>% ggplot(aes(weight,height)) + geom_point() + geom_smooth(method = "lm")
```

$$ Y = \beta_0 + \beta_1 X_1 + \epsilon $$

## RLS: datos

```{r}
espir <- read_dta("data-raw/espirometria.dta") %>% as_factor()
espir
```

## RLS: distribución {.columns-2}

- __supuestos:__
  + **#1** linealidad
  + **#2** independencia de observaciones

```{r,fig.height=3,fig.width=3}
espir %>% 
  ggplot(aes(edad,vef)) +
  geom_point()
```

- error = residual

```{r, echo=FALSE, fig.cap="", out.width = '50%'}
knitr::include_graphics("notrack/Inkedlss01_LI.jpg")
```

```{r, echo=FALSE, fig.cap="", out.width = '50%'}
knitr::include_graphics("notrack/Inkedlss02_LI.jpg")
```

## RLS: suma de mínimos cuadrados  {.columns-2}

<!--![fuente: `https://youtu.be/nk2CQITm_eo`](notrack/lss.png)-->

```{r, echo=FALSE, fig.cap="", out.width = '90%'}
knitr::include_graphics("notrack/lss.png")
```

Cálculo de la **sumatoria del cuadrado de los residuales** hacia la media y la recta:

$$ SSE(mean) = \sum (data - mean)^2 $$
$$ SSE(fit) = \sum (data - fit)^2 $$

$$ Var(x) = \frac{SSE(x)^2}{n} $$

Medida de **bondad de ajuste**:

$$ R^2 = \frac{Var(mean) - Var(fit)}{Var(mean)}  $$

## RLS: R^2^

```{r}
wm1 <- lm(vef ~ edad, data = espir)
wm1 %>% glance() %>% select(r.squared:df)
```

**INTERPRETACIÓN**

- **edad** _explica_ el **57%** de la variabilidad de **VEF**
- existe un **57%** _de reducción en_ la variabilidad de **VEF** al tomar en cuenta la **edad**

## RLS: coeficientes

```{r}
wm1 %>% tidy()
wm1 %>% confint_tidy()
```

- $\beta_{edad}$: En la población, 
- por cada incremento de **edad** en _una unidad_, el **VEF** en promedio _incrementa_ en 0.22 mL/s,
- con un intervalo de confianza AL 95% de 0.21 a 0.24 mL/s.
- Este resultado es estadísticamente significativo con un valor **p < 0.001**

## RLS: supuesto **#3** normalidad {.columns-2}

```{r, echo=FALSE, fig.cap="", out.width = '75%'}
knitr::include_graphics("notrack/Inkedlss2_LI.jpg")
```

```{r, echo=FALSE, fig.cap="", out.width = '100%'}
knitr::include_graphics("notrack/nmeth.3854-F2.jpg")
```

## RLS: supuesto **#3** normalidad {.columns-2}

```{r,fig.height=3,fig.width=3}
wm1 %>% 
  augment() %>% 
  ggplot() +
  geom_qq(aes(sample=.std.resid)) + 
  geom_qq_line(aes(sample=.std.resid))
```

- **META:** todos los puntos sobre la línea

```{r,fig.height=3,fig.width=3,eval=TRUE, echo=TRUE}
wm1 %>% augment() %>% 
  ggplot(aes(.std.resid)) +
  geom_histogram()
```

## RLS: supuesto **#4** homoscedasticidad

```{r, echo=FALSE, fig.cap="", out.width = '65%'}
knitr::include_graphics("notrack/nmeth.3854-F1.jpg")
```

## RLS: supuesto **#4** homoscedasticidad

- **META:** distribución idéntica a ambos lados de la línea

```{r,fig.height=3,fig.width=3,message=FALSE,error=FALSE}
wm1 %>% 
  augment() %>% 
  ggplot(aes(.fitted,.std.resid)) +
  geom_point() +
  geom_smooth() +
  geom_hline(yintercept = c(0))
```

## RLS: ¿cómo se ve el modelo?

$$ Y = \beta_0 + \beta_1 X_1 + \epsilon $$
$$ VEF = 0.60 + 0.22 (edad) + \epsilon $$

```{r,fig.height=3,fig.width=3}
espir %>% 
  ggplot(aes(edad,vef)) +
  geom_point() + 
  geom_smooth(method = "lm")
```

<!-- - ¿qué pasa si borramos `method = "lm"`? -->


## RLS: retroalimentación

- **R^2^** indica el porcentaje de variabilidad del desenlace (var. dependiente) explicada por el predictor (var. independiente).

- los **coeficientes** permiten predecir el posible valor del desenlace en base a un modelo estadístico.

- los **supuestos** permiten evaluar qué tan adecuado es el ajuste de los datos al modelo.

## RLS: ejercicio

- ajustar una recta

```{r,fig.height=3,fig.width=3,eval=FALSE}
espir %>% 
  ggplot(aes(edad,talla)) +
  geom____()
```

- identificar coeficientes y R^2^

```{r,eval=FALSE}
# recordar: y ~ x
wm1 <- lm(_____ ~ _____, data = _____)
wm1 %>% g_____
wm1 %>% t_____
wm1 %>% c_____
```

- evaluar supuestos: normalidad y homoscedasticidad

```{r,fig.height=3,fig.width=3,eval=FALSE}
wm1 %>% augment() %>% 
  ggplot() + _____

wm1 %>% augment() %>% 
  ggplot(aes(.fitted,.std.resid)) + __________
```

## Intermedio #1: Tabla 1 y 2

### "... ¡en un solo comando!"

```{r,message=FALSE}
compareGroups(fumar ~ edad + vef + talla + sexo,
              data = espir, byrow=T#,method=c(vef=2)
              ) %>% 
  createTable(show.all = T) #%>% export2xls("table/tab1.xls")
```

## Intermedio: distribuciones

```{r,fig.height=2,fig.width=6,message=FALSE,error=FALSE,warning=FALSE}
espir %>% 
  select(edad,vef,talla) %>% 
  gather(key,value) %>% 
  ggplot(aes(value)) +
  geom_histogram() +
  facet_wrap(~key,scales = "free")
```

```{r,echo=FALSE}
epi_summary <- function(df, x) {
  
  x_var <- enquo(x)
  
  df %>% 
    summarise(n_obs=n(),
              min=min(!!x_var,na.rm = T),
              max=max(!!x_var,na.rm = T),
              mean=mean(!!x_var,na.rm = T) %>% signif(.,
                                                    digits = str_length(str_replace(.,"(.+)\\.(.+)","\\1")) + 2),
              sd=sd(!!x_var,na.rm = T),
              q25=quantile(!!x_var,probs = 0.25,na.rm = T),
              q50=median(!!x_var,na.rm = T),
              q75=quantile(!!x_var,probs = 0.75,na.rm = T),
              skewness=moments::skewness(!!x_var,na.rm = T),
              kurtosis=moments::kurtosis(!!x_var,na.rm = T)
              ) #%>% 
    #mutate(var=enquo(x)) %>% 
    #select(var,everything())
}
```

```{r,echo=FALSE}
epi_summary(espir,vef)
```


## Regresión Lineal Múltiple  {.columns-2}

### características

- **dos o más** variables independientes (múltiple)
- **una** variable dependiente **numérica**

### objetivo

- **epidemiológico**: controlar **confusión** en el análisis.
  + estandarización (directa/indirecta), 
  + estratificación, 
  + puntajes de propensión, 
  + regresión _multivariable_

- **estadístico**: emplear múltiples predictores
  + lineales, no-lineales, segmentadas

```{r, fig.align='center',fig.width=6,fig.height=4,echo=FALSE,out.width =  '500px'}
dagconf <- dagify(y ~ x,
       y ~ conf + x,
       x ~ conf,
       labels = c("y" = "cáncer piel", 
                  "x" = "exp. solar",
                  "conf" = "café"
                  ),
       exposure = "x",
       outcome = "y")

ggdag_adjustment_set(dagconf, text = TRUE, use_labels = "label",label_size = 0.005,text_size = 4)
#ggdag_paths(dagconf, text = TRUE, use_labels = "label",label_size = 0.005,text_size = 4)
```


## RLM: distribución

```{r,fig.height=3,fig.width=4}
espir %>% 
  ggplot(aes(edad,vef,colour=sexo)) +
  geom_point()
```

## RLM: R^2^ y coeficientes

```{r, echo=FALSE}
wm1 <- lm(vef ~ edad + sexo, data = espir)
wm1 %>% glance() %>% select(r.squared:df)
```

- **edad** y **sexo** _explica_ el **60%** de la variabilidad de **VEF**.
<!--- existe un **60%** _de reducción en_ la variabilidad de **VEF** al tomar en cuenta la **edad** y el **sexo**.-->

```{r,echo=FALSE}
m1 <- wm1 %>% tidy() %>% rownames_to_column()
m2 <- wm1 %>% confint_tidy() %>% rownames_to_column()
left_join(m1, m2) %>% select(-rowname)
```

- $\beta_{sex:female}$
- En la población, el **VEF** en promedio en **mujeres** es 0.32 mL/s menor que en **hombres**,
- con un intervalo de confianza AL 95% de 0.24 a 0.41 mL/s, **_ajustando_** por edad.
- Este resultado es estadísticamente significativo con un valor **p < 0.001**
 
## RLM: supuesto normalidad y homoscedasticidad {.columns-2}

```{r,fig.height=3,fig.width=3}
wm1 %>% 
  augment() %>% 
  ggplot() +
  geom_qq(aes(sample=.std.resid)) + 
  geom_qq_line(aes(sample=.std.resid))
```

```{r,fig.height=3,fig.width=3,eval=FALSE, echo=FALSE}
wm1 %>% augment() %>% 
  ggplot(aes(.std.resid)) +
  geom_histogram()
```

```{r,fig.height=3,fig.width=3,message=FALSE,error=FALSE}
wm1 %>% 
  augment() %>% 
  ggplot(aes(.fitted,.std.resid)) +
  geom_point() +
  geom_smooth() +
  geom_hline(yintercept = c(0))
```

## RLM: post-estimación

- multicolinealidad: VIF

- outliers: puntos influenciales o ruido

## RLM: ¿cómo se ve el modelo?

$$ Y = \beta_0 + \beta_1 X_1 + \beta_2 X_2 + \epsilon $$
$$ VEF = 0.60 + 0.22 (edad) - 0.32 (sexo) + \epsilon $$

```{r,fig.height=3,fig.width=3}
wm1 %>% augment() %>% 
  ggplot(aes(colour= sexo)) +
  geom_point(aes(edad,vef),alpha=0.05) +
  geom_line(aes(edad,.fitted), lwd=1.5)
```

## RLM: ejercicio

- 3 predictores

```{r, eval=FALSE}
wm1 <- lm(vef ~ edad + sexo + fumar, data = espir)
```

- R^2^ y coeficientes

```{r,eval=FALSE}
wm1 %>% g___()
wm1 %>% t___() 
wm1 %>% c___()
```

- supuesto normalidad y homoscedasticidad

```{r,fig.height=3,fig.width=3, eval=FALSE}
wm1 %>% augment() %>% 
  ggplot() +
  geom_qq________ + 
  geom________

wm1 %>% augment() %>% 
  ggplot(aes(_____,_____)) +
  geom_p____()
```


## Intermedio #2: Modificación de efecto {.columns-2}

### ¿cómo se ve el modelo?

$$ Y = \beta_0 + \beta_1 X_1 + \beta_2 X_2 + \beta_3 (X_1 * X_2) + \epsilon $$

```{r,fig.height=3,fig.width=4,eval=FALSE, echo=FALSE}
espir %>% 
  ggplot(aes(edad,vef,colour=fumar)) +
  geom_point() + geom_smooth(method = "lm")
```

```{r,eval=TRUE, echo=FALSE}
#identificar coeficientes y R^2^
# recordar: y ~ x
#wm1 <- lm(vef ~ edad*fumar + sexo, data = espir)
wm1 <- lm(vef ~ edad*fumar, data = espir)
#wm1 %>% glance()
m1 <- wm1 %>% tidy() %>% rownames_to_column()
m2 <- wm1 %>% confint_tidy() %>% rownames_to_column()
left_join(m1, m2) %>% select(term,estimate,conf.low,conf.high#,p.value
                             )
```

- $\beta_{interacción}$
- La diferencia en la media de VEF asociado al incremento en 1 año de edad en **fumadores**
- **menos**
- la diferencia en la media de VEF asociado al incremento en 1 año de edad en **no fumadores**
- **es `r round(coef(wm1)[4],2)` mL/s**, con un IC 95% de `r round(m2$conf.low[4],2)` a `r round(m2$conf.high[4],2)`.

```{r,fig.height=3,fig.width=3,echo=FALSE, eval=FALSE}
#evaluar supuestos: normalidad
wm1 %>% augment() %>% ggplot() +
  geom_qq(aes(sample=.std.resid)) + 
  geom_qq_line(aes(sample=.std.resid))
```

```{r,fig.height=3,fig.width=3,eval=FALSE, echo=FALSE}
wm1 %>% augment() %>% 
  ggplot(aes(.std.resid)) +geom_histogram()
```

```{r,fig.height=3,fig.width=3,message=FALSE,error=FALSE, echo=FALSE,eval=FALSE}
#supuesto homoscedasticidad
wm1 %>% augment() %>% 
  ggplot(aes(.fitted,.std.resid)) +
  geom_point() +geom_smooth() +
  geom_hline(yintercept = c(0))
```

```{r,fig.height=3,fig.width=3,eval=TRUE, echo=FALSE,out.width = '90%'}
wm1 %>% augment() %>% 
  #mutate(inter=str_c(fumar,":",sexo) %>% as.factor()) %>% 
  #ggplot(aes(colour=inter)) + 
  ggplot(aes(colour=fumar)) + 
  geom_point(aes(edad,vef),alpha=0.05) +
  geom_line(aes(edad,.fitted), lwd=1.5)
```


## Estudios Observacionales

- Asociaciones entre:
  + condición (**expuesto** o no-expuesto)
  + resultado (**caso** o control)

- Tipo de análisis depende del tipo de estudio
  + "Reclutamos $x_1$ sujetos **expuestos** y $x_2$ sujetos **no expuestos**"
  + Tipo **Cohorte**
  
  + "Reclutamos $x_1$ sujetos **caso** y $x_2$ sujetos **control**"
  + Tipo **Caso-Control**

```{r,echo=FALSE,eval=TRUE,fig.align='center',out.width="50%"}
t1 <- tribble(
  ~"tipo de estudio", ~"medida de asociación",
  "caso - control", "OR",
  "transversal", "PR",
  "tiempo a evento", "HR",
  "cohorte","RR"
) 
t1 %>% 
  kable("pandoc") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),full_width = F,font_size = 10)
```

## Bases de datos

- Cohorte

```{r}
riskdb <- read_dta("data-raw/epidb.dta") %>% as_factor() %>% 
  mutate(aids=if_else(aids==0,"No","Yes") %>% as.factor(),
         ccr2=if_else(ccr2==1,"No","Yes") %>% as.factor())
```

- Encuesta a nivel nacional

```{r}
logdb <- read_dta("data-raw/brfss2000.dta") %>% as_factor() %>% 
  filter(!is.na(depress))
  #mutate(dn_cro=as.factor(dn_cro))
```

## Cohorte

- Elegimos los totales de **expuestos y no expuestos**

```{r}
riskdb %>% 
  count(ccr2,aids) %>% 
  spread(aids,n) %>% 
  mutate(risk=Yes/(No+Yes)) %>% 
  mutate(rr=.$risk[2]/.$risk[1])
```

- Si cambiamos el tamaño del grupo (**no-expuestos x 100**), **no cambia** el Riesgo Relativo (RR)

```{r,echo=FALSE}
riskdb %>% 
  count(ccr2,aids) %>% 
  spread(aids,n) %>% 
  mutate(No=if_else(ccr2=="No",No*100,No %>% as.double()),
         Yes=if_else(ccr2=="No",Yes*100,Yes %>% as.double()),
         risk=Yes/(No+Yes)) %>% 
  mutate(rr=.$risk[2]/.$risk[1])
```

## Caso Control


- Elegimos los totales de **casos y controles**

- Si cambiamos el tamaño del grupo (**casos x 100**), **sí cambia** el Riesgo Relativo (RR)

```{r,eval=FALSE}
riskdb %>% 
  count(ccr2,aids) %>% 
  spread(aids,n) %>% 
  mutate(Yes=Yes*100,
         risk=Yes/(No+Yes)) %>% 
  mutate(rr=.$risk[2]/.$risk[1])
```

- En estudios caso-control usamos el **Odds Ratio (OR)** 

```{r,echo=FALSE}
riskdb %>% 
  count(ccr2,aids) %>% 
  spread(aids,n) %>% 
  mutate(Yes=Yes*100,
         risk=Yes/(No+Yes),
         odds=Yes/No) %>% 
  mutate(rr=.$risk[2]/.$risk[1],
         or=.$odds[2]/.$odds[1])
```

- **sobreestima** el Riesgo Relativo (RR)

## Modelos Lineales Generalizados

### careacterística

### objetivo

## GLM: familias distribución y funciones de enlace

- tabla

## GLM: verosimilitud


```{r, echo=FALSE, fig.cap="", out.width = '40%'}
knitr::include_graphics("notrack/nmeth.3904-F3_A.jpg")
```

## GLM: Regresión Logística {.columns-2}

- Se aplica cuando el desenlace es **categórico dicotómico**

- El término logístico refiere a la función de enlace **logit**, que convierte el resultado binario en una variable contínua de log(odds)

$$ log\left(\frac{\pi}{1-\pi}\right) =  \beta_0 + \beta_1 X_1 + . . . + \beta_n X_n + \epsilon $$

- El valor exponenciado de los coeficientes se pueden interpretar como **Odds Ratio (OR)**

```{r,fig.height=2,fig.width=3}
data_frame(x=seq(0,1,0.01)) %>% 
  mutate(odd=x/(1-x)) %>% 
  ggplot(aes(x,log(odd))) +
  geom_point() +
  coord_flip()
```


## GLM: ¿bondad de ajuste?

- LogLikelihood
- Information Criterias
  + AIC
  + BIC

## GLM: ¿Supuestos?

## OR: Caso-Control {.columns-2}

- Simularemos un escenario Caso-Control
- Seleccionaremos al azar **500 casos y 500 controles**

```{r}
riskdb_or <- riskdb %>% 
  group_by(aids) %>% 
  sample_n(50) %>% 
  ungroup()
```

```{r,fig.height=2,fig.width=3, echo=TRUE}
riskdb_or %>% ggplot(aes(aids,fill=ccr2)) +
  geom_bar(position = "fill")
```

```{r}
riskdb_or %>% 
  count(aids) %>% 
  mutate(prc=n/sum(n))
```

```{r, echo=FALSE}
riskdb_or %>% 
  count(ccr2,aids) %>% 
  spread(aids,n) %>% 
  mutate(odds=Yes/No) %>% 
  mutate(or=.$odds[2]/.$odds[1])
```

## OR: coeficientes de variables categóricas

```{r}
wm1 <- glm(aids ~ ccr2, data = riskdb_or, family = binomial(link = "logit"))
```

```{r,echo=FALSE}
#wm1 %>% glance()
m1 <- wm1 %>% tidy() %>% mutate(odds=exp(estimate)) %>% rownames_to_column()
m2 <- wm1 %>% confint_tidy() %>% mutate_all(funs(exp)) %>% rownames_to_column()
left_join(m1,m2) %>% select(term,log.odds=estimate,odds,conf.low,conf.high,p.value)
```

- $\beta_0$
- En la población, el **odds** de tener sida dado que **no poseen CCR2** es **`r round(m1$odds[1],2)`**,
- con un intervalo de confianza al 95% de `r round(m2$conf.low[1],2)` a `r round(m2$conf.high[1],2)`

- $\beta_{CCR2:Yes}$
- En la población, el **odds** de tener sida dado que **sí poseen CCR2** es
- **`r round(m1$odds[2],2)`** veces, 
- el **odds** de tener depresión dado que **no poseen CCR2**,
- con un intervalo de confianza al 95% de `r round(m2$conf.low[2],2)` a `r round(m2$conf.high[2],2)`.
- Este resultado no es estadísticamente significativo con un valor **p = `r round(m1$p.value[2],3)`**

## OR: coeficientes de variables contínuas 

```{r}
wm1 <- glm(aids ~ age, data = riskdb_or, family = binomial(link = "logit"))
```

```{r,echo=FALSE}
#wm1 %>% glance()
m1 <- wm1 %>% tidy() %>% mutate(odds=exp(estimate)) %>% rownames_to_column()
m2 <- wm1 %>% confint_tidy() %>% mutate_all(funs(exp)) %>% rownames_to_column()
left_join(m1,m2) %>% select(term,log.odds=estimate,odds,conf.low,conf.high,p.value)
```

- $\beta_{edad}$
- En la población, por cada incremento en un año de **edad**,
- el **odds** de sida _cambia_ en **`r round(m1$odds[2],2)`**, con un intervalo de confianza AL 95% de `r round(m2$conf.low[2],2)` a `r round(m2$conf.high[2],2)`.
- Este resultado no es estadísticamente significativo con un valor **p = `r round(m1$p.value[2],3)`**
 
```{r,fig.height=3,fig.width=3, echo=FALSE, eval=FALSE}
## OR: supuesto
wm1 %>% 
  augment() %>% 
  ggplot() +
  geom_qq(aes(sample=.std.resid)) + 
  geom_qq_line(aes(sample=.std.resid))

#**META:** todos los puntos sobre la línea
```

```{r,fig.height=3,fig.width=3,eval=FALSE, echo=FALSE}
wm1 %>% augment() %>% 
  ggplot(aes(.std.resid)) +
  geom_histogram()
  #geom_density()
```

```{r,fig.height=3,fig.width=3,message=FALSE,error=FALSE, echo=FALSE,eval=FALSE}
wm1 %>% 
  augment() %>% 
  ggplot(aes(age,.std.resid)) +
  geom_point() +
  geom_smooth() +
  geom_hline(yintercept = c(0))
#- **META:** distribución idéntica a ambos lados de la línea
```

## RR: Cohorte

```{r}
wm1 <- glm(aids ~ ccr2, data = riskdb, family = binomial(link = "log"))
```

```{r,echo=FALSE}
#wm1 %>% glance()
m1 <- wm1 %>% tidy() %>% mutate(odds=exp(estimate)) %>% rownames_to_column()
m2 <- wm1 %>% confint_tidy() %>% mutate_all(funs(exp)) %>% rownames_to_column()
left_join(m1,m2) %>% select(term,log.odds=estimate,odds,conf.low,conf.high,p.value)
```

- $\beta_0$
- En la población, el **riesgo** de sida dado que **no poseen CCR2** es **`r round(m1$odds[1],2)`**,
- con un intervalo de confianza AL 95% de `r round(m2$conf.low[1],2)` a `r round(m2$conf.high[1],2)`

- $\beta_{CCR2:Yes}$
- En la población, el **riesgo** de tener sida dado que **sí poseen CCR2** es
- **`r round(m1$odds[2],2)`** veces, 
- el **riesgo** de tener sida dado que **no poseen CCR2**,
- con un intervalo de confianza AL 95% de `r round(m2$conf.low[2],2)` a `r round(m2$conf.high[2],2)`.
- Este resultado no es estadísticamente significativo con un valor **p = `r round(m1$p.value[2],3)`**


## PR: Transversal

```{r}
wm1 <- glm(depress ~ short, data = logdb, family = binomial(link = "log"))
```

```{r,echo=FALSE}
#wm1 %>% glance()
m1 <- wm1 %>% tidy() %>% mutate(odds=exp(estimate)) %>% rownames_to_column()
m2 <- wm1 %>% confint_tidy() %>% mutate_all(funs(exp)) %>% rownames_to_column()
left_join(m1,m2) %>% select(term,log.odds=estimate,odds,conf.low,conf.high,p.value)
```

- $\beta_0$
- En la población, la **prevalencia** de depresión en sujetos que **estatura alta** es **`r round(m1$odds[1],2)`**,
- con un intervalo de confianza AL 95% de `r round(m2$conf.low[1],2)` a `r round(m2$conf.high[1],2)`

- $\beta_{estatura:baja}$
- En la población, la **prevalencia** de tener depresión dado que se es de **estatura baja** es
- **`r round(m1$odds[2],2)`** veces, 
- el **prevalencia** de tener depresión dado que se es de **estatura alta**,
- con un intervalo de confianza AL 95% de `r round(m2$conf.low[2],2)` a `r round(m2$conf.high[2],2)`.
- Este resultado es estadísticamente significativo con un valor **p = `r round(m1$p.value[2],3)`**


## HR: Tiempo a evento

### Log-Rank test

```{r,echo=FALSE}
coxdb <- riskdb %>% 
  mutate(aids=as.integer(aids)-1)
```

```{r,fig.height=5,fig.width=7,echo=FALSE}
fit <- survfit(Surv(ttoaidsorexit, aids) ~ ccr2, data =  coxdb)
# Visualize with survminer
ggsurvplot(fit, data = coxdb, risk.table = TRUE,
           conf.int = T,ggtheme = theme_minimal(),pval = T)
```

## HR: Tiempo a evento

### Regresión de Cox

```{r}
res.cox <- coxph(Surv(ttoaidsorexit, aids) ~ ccr2, data =  coxdb)
```

```{r,echo=FALSE}
#res.cox %>% glance()
m1 <- res.cox %>% tidy() %>% rownames_to_column()
m2 <- res.cox %>% confint_tidy() %>% rownames_to_column()
left_join(m1,m2) %>% select(-rowname)
#res.cox %>% augment()
```

## IRR: Desenlaces conteo o tasas

```{r,eval=FALSE}
glm(response~predictor1+predictor2+predictor3+ ... + offset(log(population)),
     family=poisson,data=...)
#https://stats.stackexchange.com/questions/66791/where-does-the-offset-go-in-poisson-negative-binomial-regression/66878#66878
#https://stackoverflow.com/questions/16046726/regression-for-a-rate-variable-in-r
```


## Referencias

### Presentaciones

- Curso de Bioestadística. Maestría en Ciencias de la Investigación Epidemiológica. UPCH 2018.
- José Alfredo Zavala. Regresión Lineal. 2018
- Harold Akehurst. Bioestadística con R. Julio 2016

### enlaces web

- StatQuest: Linear Models Pt.1 - Linear Regression. Link: `https://youtu.be/nk2CQITm_eo`
- Statistics for Biologist: Points of Significance. Link: `https://www.nature.com/collections/qghhqm/pointsofsignificance`


```{r cars, eval=FALSE, echo=FALSE}
esoph %>% as_tibble()
```

```{r, eval=FALSE , echo=FALSE}
require(stats)
require(graphics) # for mosaicplot

esoph <- as_tibble(esoph)

summary(esoph)
```

```{r, eval=FALSE , echo=FALSE}
prop.table(table(esoph$agegp))
```

```{r, eval=FALSE , echo=FALSE}
## effects of alcohol, tobacco and interaction, age-adjusted
model1 <- glm(cbind(ncases, ncontrols) ~ agegp + tobgp * alcgp,
              data = esoph, family = binomial())
anova(model1)

summary(model1)

attributes(model1)

#broom::augment(model1)
broom::tidy(model1)
broom::confint_tidy(model1)
broom::glance(model1)

plot(model1,which = 1) #homoscedasticidad (de predichos yhat vs residuales)
plot(model1,which = 2) #normalidad (de residuales)
```

```{r, eval=FALSE , echo=FALSE}
## Try a linear effect of alcohol and tobacco
model2 <- glm(cbind(ncases, ncontrols) ~ agegp + unclass(tobgp)
                                         + unclass(alcgp),
              data = esoph, family = binomial())
summary(model2)
```

```{r, eval=FALSE , echo=FALSE}
## Re-arrange data for a mosaic plot
ttt <- table(esoph$agegp, esoph$alcgp, esoph$tobgp)
o <- with(esoph, order(tobgp, alcgp, agegp))
ttt[ttt == 1] <- esoph$ncases[o]
tt1 <- table(esoph$agegp, esoph$alcgp, esoph$tobgp)
tt1[tt1 == 1] <- esoph$ncontrols[o]
tt <- array(c(ttt, tt1), c(dim(ttt),2),
            c(dimnames(ttt), list(c("Cancer", "control"))))
mosaicplot(tt, main = "esoph data set", color = TRUE)
```

